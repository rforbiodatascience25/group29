---
title: "Lab 7 Assignment: Group 29"
subtitle: "Amalie Frøsig (s224989), Frida De los Rios (s251977), Mille Grinder (s224965), Niels Elfenbein (s225059) & Tomás García-Cardo Raskovsky (s250441)"
format:
  html:
    embed-resources: true
editor: visual
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

## Load libraries

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(broom)
library(cowplot)
```

## Load data

```{r}
#| message: false
#| warning: false

raw_dir <- "data/_raw/"
data_file <- "gravier.RData"
data_loc <- "https://github.com/ramhiser/datamicroarray/raw/master/data/"

if( !dir.exists(raw_dir) ){
  dir.create(path = raw_dir)
}
if( !file.exists(str_c(raw_dir, data_file)) ){
  download.file(
    url = str_c(data_loc, data_file),
    destfile = str_c(raw_dir, data_file))
}
load(file = str_c(raw_dir, data_file))

```

The data frame is then converted to a tibble and early_metastasis is added as a column in the beginning.

```{r}
#| message: false
#| warning: false

gravier <- gravier |>
  bind_cols() |>
  as_tibble() |>
  mutate(y = case_when(y == "poor" ~ "poor",
                       y == "good" ~ "good")) |> 
  relocate(early_metastasis = y) |>
  select(1:101)
```

## Analysis

### PCA of the data

```{r}
#| message: false
#| warning: false

pca_fit <- gravier |> 
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)
```

### Visualization of PCA, including augmented dataset

```{r}
#| message: false
#| warning: false

pca_fit |> 
  augment(gravier) |> 
  ggplot(aes(.fittedPC1, 
             .fittedPC2, 
             color = early_metastasis)) +
  geom_point(size = 1.5,
             alpha = 0.4) +
  scale_color_manual(values = c(poor = "red", 
                                good = "blue")) +
  labs(title = "PCA of Gravier data",
       color = "Early metastasis") +
  theme_classic(base_size = 16)

```

This is a representation of the first two dimensions in PCA analysis for the Gravier dataset. The datapoints are colored according to the metastastatic behavior associated with each gene. From the visualization, it can be extracted that the first dimension contains most of the variance in the data, as the data points seem to be more dispersed around the x-axis. There is no apparent difference among the two metastatic conditions.

### Visualization of rotation matrix

### Visualization of the variance

```{r}
#| message: false
#| warning: false

pca_fit |>
  tidy(matrix = "eigenvalues") |>
  filter(PC <= 9) |>
  ggplot(aes(x = PC,
             y = percent)) +
  geom_col(fill = "hotpink") +
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic(base_size = 16) +
  labs(title = "Variance explained by each PC",
       x = "PC",
       y = "Percent of variation")
```

This is a bar-plot representing the variance percentage contained in each PC. It easily shows that the first dimension accounts for more than half of the total variance, which was already hinted by previous visualizations.
